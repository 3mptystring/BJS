<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>startup/server/index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger"/>
<label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2>
    <h3>Classes</h3>
    <ul>
        <li><a href="Account.html">Account</a></li>
        <li><a href="Athlete.html">Athlete</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athlete.html#.decryptFromDatabase">decryptFromDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#addMeasurement">addMeasurement</a></li>
                <li data-type='method'><a href="Athlete.html#check">check</a></li>
                <li data-type='method'><a href="Athlete.html#encryptForDatabase">encryptForDatabase</a></li>
                <li data-type='method'><a href="Athlete.html#getCertificateWritten">getCertificateWritten</a></li>
                <li data-type='method'><a href="Athlete.html#getFullName">getFullName</a></li>
                <li data-type='method'><a href="Athlete.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Athlete.html#getShortName">getShortName</a></li>
                <li data-type='method'><a href="Athlete.html#setCertificateWritten">setCertificateWritten</a></li>
            </ul>
        </li>
        <li><a href="Data.html">Data</a>
            <ul class='methods'>
                <li data-type='method'><a href="Data.html#findEncrypted">findEncrypted</a></li>
                <li data-type='method'><a href="Data.html#getPlain">getPlain</a></li>
                <li data-type='method'><a href="Data.html#push">push</a></li>
            </ul>
        </li>
        <li><a href="Log.html">Log</a>
            <ul class='methods'>
                <li data-type='method'><a href="Log.html#clear">clear</a></li>
                <li data-type='method'><a href="Log.html#custom">custom</a></li>
                <li data-type='method'><a href="Log.html#disable">disable</a></li>
                <li data-type='method'><a href="Log.html#enable">enable</a></li>
                <li data-type='method'><a href="Log.html#error">error</a></li>
                <li data-type='method'><a href="Log.html#getAsString">getAsString</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithLevel">getAsStringWithLevel</a></li>
                <li data-type='method'><a href="Log.html#getAsStringWithMinLevel">getAsStringWithMinLevel</a></li>
                <li data-type='method'><a href="Log.html#info">info</a></li>
                <li data-type='method'><a href="Log.html#merge">merge</a></li>
                <li data-type='method'><a href="Log.html#warning">warning</a></li>
            </ul>
        </li>
        <li><a href="SessionAccount.html">SessionAccount</a>
            <ul class='methods'>
                <li data-type='method'><a href="SessionAccount.html#canViewResults">canViewResults</a></li>
                <li data-type='method'><a href="SessionAccount.html#get">get</a></li>
                <li data-type='method'><a href="SessionAccount.html#isAdminAccount">isAdminAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isGroupAccount">isGroupAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#isLoggedIn">isLoggedIn</a></li>
                <li data-type='method'><a href="SessionAccount.html#isStationAccount">isStationAccount</a></li>
                <li data-type='method'><a href="SessionAccount.html#login">login</a></li>
                <li data-type='method'><a href="SessionAccount.html#logout">logout</a></li>
                <li data-type='method'><a href="SessionAccount.html#setProcessing">setProcessing</a></li>
                <li data-type='method'><a href="SessionAccount.html#store">store</a></li>
            </ul>
        </li>
    </ul>
    <h3>Namespaces</h3>
    <ul>
        <li><a href="AccountManager.html">AccountManager</a>
            <ul class='methods'>
                <li data-type='method'><a href="AccountManager.html#.getAdminAccount">getAdminAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getGroupAccount">getGroupAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getOutputAccount">getOutputAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.getStationAccount">getStationAccount</a></li>
                <li data-type='method'><a href="AccountManager.html#.inputPermitted">inputPermitted</a></li>
                <li data-type='method'><a href="AccountManager.html#.login">login</a></li>
                <li data-type='method'><a href="AccountManager.html#.logout">logout</a></li>
                <li data-type='method'><a href="AccountManager.html#.retrieveAccounts">retrieveAccounts</a></li>
                <li data-type='method'><a href="AccountManager.html#.viewPermitted">viewPermitted</a></li>
            </ul>
        </li>
        <li><a href="Athletics.html">Athletics</a>
            <ul class='methods'>
                <li data-type='method'><a href="Athletics.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Athletics.html#.calculateOne">calculateOne</a></li>
                <li data-type='method'><a href="Athletics.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Athletics.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Athletics.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Athletics.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Athletics.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Athletics.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Athletics.html#.validate">validate</a></li>
            </ul>
        </li>
        <li><a href="Crypto.html">Crypto</a>
            <ul class='methods'>
                <li data-type='method'><a href="Crypto.html#.encrypt">encrypt</a></li>
                <li data-type='method'><a href="Crypto.html#.generateAC">generateAC</a></li>
                <li data-type='method'><a href="Crypto.html#.generateLoginToken">generateLoginToken</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePrivHash">generatePrivHash</a></li>
                <li data-type='method'><a href="Crypto.html#.generatePubHash">generatePubHash</a></li>
                <li data-type='method'><a href="Crypto.html#.tryDecrypt">tryDecrypt</a></li>
            </ul>
        </li>
        <li><a href="DBInterface.html">DBInterface</a>
            <ul class='methods'>
                <li data-type='method'><a href="DBInterface.html#.activateCompetition">activateCompetition</a></li>
                <li data-type='method'><a href="DBInterface.html#.generateCertificates">generateCertificates</a></li>
                <li data-type='method'><a href="DBInterface.html#.getActivatedSports">getActivatedSports</a></li>
                <li data-type='method'><a href="DBInterface.html#.getAthletesOfAccounts">getAthletesOfAccounts</a></li>
                <li data-type='method'><a href="DBInterface.html#.getCompetitionName">getCompetitionName</a></li>
                <li data-type='method'><a href="DBInterface.html#.getCompetitionSportTypes">getCompetitionSportTypes</a>
                </li>
                <li data-type='method'><a href="DBInterface.html#.getCompetitionType">getCompetitionType</a></li>
                <li data-type='method'><a href="DBInterface.html#.getCompetitionTypeID">getCompetitionTypeID</a></li>
                <li data-type='method'><a href="DBInterface.html#.getContestID">getContestID</a></li>
                <li data-type='method'><a href="DBInterface.html#.getEditInformation">getEditInformation</a></li>
                <li data-type='method'><a href="DBInterface.html#.getGenericID">getGenericID</a></li>
                <li data-type='method'><a href="DBInterface.html#.getServerIPs">getServerIPs</a></li>
                <li data-type='method'><a href="DBInterface.html#.isReady">isReady</a></li>
                <li data-type='method'><a href="DBInterface.html#.listCompetitions">listCompetitions</a></li>
                <li data-type='method'><a href="DBInterface.html#.listEditCompetitions">listEditCompetitions</a></li>
                <li data-type='method'><a href="DBInterface.html#.removeCompetition">removeCompetition</a></li>
                <li data-type='method'><a
                        href="DBInterface.html#.setCertificateWrittenTrue">setCertificateWrittenTrue</a></li>
                <li data-type='method'><a href="DBInterface.html#.waitForReady">waitForReady</a></li>
                <li data-type='method'><a href="DBInterface.html#.writeCompetition">writeCompetition</a></li>
            </ul>
        </li>
        <li><a href="NewCompetition.html">NewCompetition</a>
            <ul class='methods'>
                <li data-type='method'><a href="NewCompetition.html#.getCompetitionType">getCompetitionType</a></li>
                <li data-type='method'><a href="NewCompetition.html#.getCompetitionTypeID">getCompetitionTypeID</a></li>
                <li data-type='method'><a href="NewCompetition.html#.getGroups">getGroups</a></li>
                <li data-type='method'><a href="NewCompetition.html#.getName">getName</a></li>
                <li data-type='method'><a href="NewCompetition.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="NewCompetition.html#.resetSportTypes">resetSportTypes</a></li>
                <li data-type='method'><a href="NewCompetition.html#.save">save</a></li>
                <li data-type='method'><a href="NewCompetition.html#.setCompetitionTypeID">setCompetitionTypeID</a></li>
                <li data-type='method'><a href="NewCompetition.html#.setGroups">setGroups</a></li>
                <li data-type='method'><a href="NewCompetition.html#.setName">setName</a></li>
                <li data-type='method'><a href="NewCompetition.html#.setSports">setSports</a></li>
            </ul>
        </li>
        <li><a href="Swimming.html">Swimming</a>
            <ul class='methods'>
                <li data-type='method'><a href="Swimming.html#.calculate">calculate</a></li>
                <li data-type='method'><a href="Swimming.html#.canDoSportType">canDoSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.generateCertificate">generateCertificate</a></li>
                <li data-type='method'><a href="Swimming.html#.getCertificateInfo">getCertificateInfo</a></li>
                <li data-type='method'><a href="Swimming.html#.getInformation">getInformation</a></li>
                <li data-type='method'><a href="Swimming.html#.getNameOfSportType">getNameOfSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getSports">getSports</a></li>
                <li data-type='method'><a href="Swimming.html#.getSportType">getSportType</a></li>
                <li data-type='method'><a href="Swimming.html#.getValidData">getValidData</a></li>
                <li data-type='method'><a href="Swimming.html#.validate">validate</a></li>
            </ul>
        </li>
    </ul>
    <h3>Global</h3>
    <ul>
        <li><a href="global.html#canViewResults">canViewResults</a></li>
        <li><a href="global.html#checkAdminLogin">checkAdminLogin</a></li>
        <li><a href="global.html#checkLogin">checkLogin</a></li>
        <li><a href="global.html#filterUndefined">filterUndefined</a></li>
        <li><a href="global.html#genRandomCode">genRandomCode</a></li>
        <li><a href="global.html#genUUID">genUUID</a></li>
        <li><a href="global.html#getAccountByPassphrase">getAccountByPassphrase</a></li>
        <li><a href="global.html#getAcsFromAccounts">getAcsFromAccounts</a></li>
        <li><a href="global.html#getAdminAccount">getAdminAccount</a></li>
        <li><a href="global.html#getCompetitionTypeByID">getCompetitionTypeByID</a></li>
        <li><a href="global.html#getGroupNames">getGroupNames</a></li>
        <li><a href="global.html#getLoginObject">getLoginObject</a></li>
        <li><a href="global.html#getLoginToken">getLoginToken</a></li>
        <li><a href="global.html#getStationNames">getStationNames</a></li>
        <li><a href="global.html#getStationNamesAsArray">getStationNamesAsArray</a></li>
        <li><a href="global.html#initCollections">initCollections</a></li>
        <li><a href="global.html#isAdminAccount">isAdminAccount</a></li>
        <li><a href="global.html#isGroupAccount">isGroupAccount</a></li>
        <li><a href="global.html#isStationAccount">isStationAccount</a></li>
    </ul>
</nav>

<div id="main">

    <h1 class="page-title">startup/server/index.js</h1>


    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {initCollections} from "../../api/database/collections/index";
import {DBInterface} from "../../api/database/db_access";
import {Account, checkLogin} from "../../api/logic/account";
import {Crypto} from "../../api/crypto/crypto";
import {encryptedAthletesToGroups} from "../../api/logic/athlete";
import {Log} from "../../api/log";


/**
 * Returns the admin account.
 * @returns {Account}
 */
function getAdminAccount() {
    return Meteor.COLLECTIONS.Generic.handle.findOne().adminAccount;
}

/**
 *
 * @param {LoginObject} loginObject
 * @returns {boolean}
 */
function checkAdminLogin(loginObject) { //TODO check isAdmin member
    return checkLogin(getAdminAccount(), loginObject);
}

function encryptAsAdmin(data) {
    return Crypto.encrypt(data, getAdminAccount().ac, getAdminAccount().ac);
}

function encryptAs(data, account) {
    return Crypto.encrypt(data, account.ac, account.ac);
}

export function onStartup() {
    // Load the config.json into the (semi-global) Meteor.config object
    Meteor.config = require('../../../config.json');
    if (Meteor.config.competitionMongoURL === "EQUAL") Meteor.config.competitionMongoURL = process.env.MONGO_URL.replace(/([^\/]*)$/, "");

    initCollections();

    const ac = Crypto.generateAC(Meteor.config.adminPassword, Meteor.config.adminSalt);
    const adminAccount = new Account("Administrator", ['Q#z'], [], ac, true, true);
    Meteor.COLLECTIONS.Generic.handle.update(
        {_id: DBInterface.getGenericID()},
        {$set: {adminAccount: adminAccount}}
    );


    Meteor.methods({
        'activateCompetition': function (loginObject, competitionName) {
            if (!checkAdminLogin(loginObject)) return encryptAsAdmin(false);
            Meteor.COLLECTIONS.switch(competitionName);
            return encryptAsAdmin(true);
        },
        'removeCompetition': function (loginObject, competitionName) {
            if (!checkAdminLogin(loginObject)) return encryptAsAdmin(false);
            let listOFEditCompetitions = DBInterface.listEditCompetitions();
            let listOFCompetitions = DBInterface.listCompetitions();
            if (listOFEditCompetitions.indexOf(competitionName) != -1) {
                Meteor.COLLECTIONS.Generic.handle.update({_id: DBInterface.getGenericID()}, {
                    $set: {
                        editContests: _.filter(listOFEditCompetitions, function (name) {
                            return name != competitionName;
                        })
                    }
                });
            } else if (listOFCompetitions.indexOf(competitionName) != -1) {
                Meteor.COLLECTIONS.Generic.handle.update({_id: DBInterface.getGenericID()}, {
                    $set: {
                        contests: _.filter(listOFCompetitions, function (name) {
                            return name != competitionName;
                        })
                    }
                });
            }
            return encryptAsAdmin(true);
        },
        'writeCompetition': function (loginObject, competitionName, competitionTypeID, sportTypes, encrypted_athletes, accounts, final) {
            if (!checkAdminLogin(loginObject)) return encryptAsAdmin(false);
            // update index in Generic
            let listOFEditCompetitions = DBInterface.listEditCompetitions();
            if (final) {
                //remove from edit contest
                Meteor.COLLECTIONS.Generic.handle.update({_id: DBInterface.getGenericID()}, {
                    $set: {
                        editContests: _.filter(listOFEditCompetitions, function (name) {
                            return name != competitionName;
                        })
                    }
                });

                let listOFCompetitions = DBInterface.listCompetitions();
                if (listOFCompetitions.indexOf(competitionName) == -1) {
                    listOFCompetitions.push(competitionName);
                    Meteor.COLLECTIONS.Generic.handle.update({_id: DBInterface.getGenericID()}, {$set: {contests: listOFCompetitions}});
                }
            } else {
                if (listOFEditCompetitions.indexOf(competitionName) == -1) {
                    listOFEditCompetitions.push(competitionName);
                    Meteor.COLLECTIONS.Generic.handle.update({_id: DBInterface.getGenericID()}, {$set: {editContests: listOFEditCompetitions}});
                }
            }

            // create collections if they don't exist
            Meteor.COLLECTIONS.connect(competitionName);

            // clear collections
            Meteor.COLLECTIONS.Accounts.handles[competitionName].remove({});
            Meteor.COLLECTIONS.Athletes.handles[competitionName].remove({});
            Meteor.COLLECTIONS.Contest.handles[competitionName].remove({});

            // write data
            //write athletes
            for (let athlete in encrypted_athletes) {
                if (!encrypted_athletes.hasOwnProperty(athlete)) continue;
                Meteor.COLLECTIONS.Athletes.handles[competitionName].insert(encrypted_athletes[athlete]);
            }

            //write accounts
            for (let account in accounts) {
                if (!accounts.hasOwnProperty(account)) continue;
                Meteor.COLLECTIONS.Accounts.handles[competitionName].insert(accounts[account]);
            }

            //write general information
            Meteor.COLLECTIONS.Contest.handles[competitionName].insert({
                contestType: competitionTypeID,
                sportTypes: sportTypes
            });

            if (final) {
                Meteor.call('activateCompetition', loginObject, competitionName);
            }

            return encryptAsAdmin(true);
        },
        'getEditInformation': function (loginObject, competitionName) {
            if (!checkAdminLogin(loginObject)) return undefined;
            let listOFEditCompetitions = DBInterface.listEditCompetitions();
            if (listOFEditCompetitions.indexOf(competitionName) == -1) return undefined;

            const contestDBHandle = Meteor.COLLECTIONS.Contest.handles[competitionName];

            const competitionTypeID = DBInterface.getCompetitionTypeID(contestDBHandle);
            const sportTypes = DBInterface.getActivatedSports(contestDBHandle);

            const encryptedAthletes = Meteor.COLLECTIONS.Athletes.handles[competitionName].find().fetch();

            return encryptAsAdmin({
                competitionTypeID: competitionTypeID,
                sportTypes: sportTypes,
                encryptedAthletes: encryptedAthletes
            });
        },
        'generateCertificates': function (loginObject) {
            const account = Meteor.COLLECTIONS.Accounts.handle.findOne({"ac.pubHash": loginObject.pubHash});

            if (!account) {
                return false;
            }
            if (!account.canViewResults) {
                return encryptAs(false, account);
            }

            const ct = DBInterface.getCompetitionType();
            const log = new Log();

            const accounts = Meteor.COLLECTIONS.Accounts.handle.find().fetch();
            const encryptedAthletes = Meteor.COLLECTIONS.Athletes.handle.find().fetch();

            const groups = encryptedAthletesToGroups(encryptedAthletes, accounts, true, true);

            let mapAthletet = function (athlete) {
                const certificate = ct.generateCertificate(log, athlete, accounts, true);
                // console.log(certificate);
                const stScores = [];

                for (let stID in certificate.stScores) {
                    if (!certificate.stScores.hasOwnProperty(stID)) continue;
                    stScores.push({
                        stID: stID,
                        name: ct.getNameOfSportType(stID),
                        score: certificate.stScores[stID]
                    });
                }

                return {
                    name: athlete.getFullName(),
                    id: athlete.id,
                    certificateWritten: athlete.certificateWritten,
                    valid: ct.validate(log, athlete, accounts, true),
                    score: certificate.score,
                    stScores: stScores,
                    certificate: certificate.certificate,
                    certificateName: certificate.certificate === 2 ? "Ehrenurkunde" : (certificate.certificate === 1 ? "Siegerurkunde" : (certificate.certificate === 0 ? "Teilnehmerurkunde" : "Fehler"))
                };
            };

            for (let groupGroupID in groups) {
                if (!groups.hasOwnProperty(groupGroupID)) continue;
                groups[groupGroupID].athletes = _.map(groups[groupGroupID].athletes, mapAthletet);
            }

            return encryptAs(groups, account);
        },
        'getServerIPs': function () {
            const os = require('os');
            const ifaces = os.networkInterfaces();
            const ips = [];

            Object.keys(ifaces).forEach(function (ifname) {
                ifaces[ifname].forEach(function (iface) {
                    if ('IPv4' !== iface.family || iface.internal !== false) {
                        return;
                    }
                    ips.push(iface.address);
                });
            });
            return ips;
        },
        'setCertificateWrittenTrue': function (loginObject, id) {
            const account = Meteor.COLLECTIONS.Accounts.handle.findOne({"ac.pubHash": loginObject.pubHash});

            if (!account) {
                return false;
            }
            if (!account.canViewResults) {
                return encryptAs(false, account);
            }

            Meteor.COLLECTIONS.Athletes.handle.update({_id: id}, {$set: {certificateWritten: true}});
        }
    });

    // require('../../api/database/db_example')();
}</code></pre>
        </article>
    </section>


</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Thu Jan 05 2017 01:42:10
    GMT+0100 (CET) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
